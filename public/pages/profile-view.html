<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profil - HotMeet</title>
    <link rel="stylesheet" href="/css/style.css?v=6" />
    <link rel="stylesheet" href="/css/pages.css?v=1" />
    <link rel="stylesheet" href="/css/animations.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <nav class="nav">
        <a href="/" class="nav-brand">
          <img
            src="/images/logo-hotmeet.png"
            alt="HotMeet - Rencontres Adultes Premium"
            class="logo-img"
          />
          <span class="logo-text">HotMeet</span>
        </a>

        <div class="nav-menu" id="navMenu">
          <a href="/" class="nav-link">Accueil</a>
          <a href="/directory" class="nav-link">Annuaire</a>
          <a href="/ads" class="nav-link">Annonces</a>
          <a href="/tonight" class="nav-link">Ce Soir</a>
          <a href="/cam" class="nav-link">Cam-to-Cam</a>
          <a href="/messages" class="nav-link">Messages</a>
          <a href="/profile" class="nav-link">Mon Profil</a>
        </div>

        <div class="nav-actions">
          <button class="btn-secondary" id="loginBtn">Connexion</button>
          <button class="btn-primary" id="registerBtn">Inscription</button>
          <div class="mobile-menu-toggle" id="mobileMenuToggle">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="pages-container">
      <div class="container">
        <!-- Loading -->
        <div id="loadingIndicator" class="loading-container">
          <div class="loading-spinner"></div>
          <p>Chargement du profil...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message" style="display: none">
          <p>Erreur lors du chargement du profil.</p>
          <button class="btn-primary" id="backBtn">Retour</button>
        </div>

        <!-- Profile Content -->
        <div id="profileContent" style="display: none">
          <!-- Profile Header -->
          <section class="profile-header">
            <div class="profile-info">
              <img
                id="profilePhoto"
                src=""
                alt="Photo de profil"
                class="profile-photo"
              />
              <div class="profile-details">
                <h1 id="profileName" class="profile-title"></h1>
                <p id="profileDetails" class="profile-subtitle"></p>
                <div id="profileStats" class="profile-stats">
                  <span>üëÅÔ∏è <span id="profileViews">0</span> vues</span>
                  <span>üìÖ Membre depuis <span id="memberSince">-</span></span>
                </div>
              </div>
            </div>
          </section>

          <!-- Profile Actions -->
          <section class="profile-actions">
            <button id="sendMessageBtn" class="btn-primary">
              üí¨ Envoyer un message
            </button>
            <button id="backToDirectoryBtn" class="btn-secondary">
              ‚Üê Retour √† l'annuaire
            </button>
          </section>

          <!-- Profile Bio -->
          <section class="profile-section" id="bioSection">
            <h2>√Ä propos</h2>
            <div id="profileBio" class="bio-content">
              <!-- Bio content will be loaded here -->
            </div>
          </section>

          <!-- Profile Photos -->
          <section class="profile-section">
            <h2>Photos</h2>
            <div class="photo-gallery" id="galleryPhotos">
              <!-- Gallery photos will be loaded here -->
            </div>
          </section>
        </div>
      </div>
    </main>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script>
      // Simple JavaScript pour charger et afficher le profil
      class SimpleProfileView {
        constructor() {
          this.userId = null;
          this.init();
        }

        init() {
          const urlParams = new URLSearchParams(window.location.search);
          this.userId = urlParams.get('id');

          if (!this.userId) {
            this.showError('ID utilisateur manquant');
            return;
          }

          this.loadProfile();
          this.initEventListeners();
        }

        async loadProfile() {
          try {
            const token = localStorage.getItem('hotmeet_token');
            if (!token) {
              window.location.href = '/auth';
              return;
            }

            const response = await fetch(`/api/users/${this.userId}`, {
              headers: { Authorization: `Bearer ${token}` },
            });

            if (!response.ok) {
              this.showError('Profil non trouv√©');
              return;
            }

            const data = await response.json();
            console.log("Donn√©es re√ßues de l'API:", data);
            this.displayProfile(data.user);
            this.hideLoading();
          } catch (error) {
            this.showError('Erreur lors du chargement');
          }
        }

        displayProfile(user) {
          const profile = user.profile;

          // Titre
          document.title = `${profile.nom} - HotMeet`;

          // Photo
          const profilePhoto =
            profile.photos?.find(p => p.isProfile) || profile.photos?.[0];
          document.getElementById('profilePhoto').src =
            profilePhoto?.path || '/images/default-avatar.jpg';

          // Infos
          document.getElementById('profileName').textContent = profile.nom;
          const location = profile.localisation;
          const locationText = location
            ? `${location.ville}, ${location.region}, ${location.pays}`
            : '';
          document.getElementById('profileDetails').textContent =
            `${profile.age} ans ‚Ä¢ ${locationText}`;

          // Stats
          document.getElementById('profileViews').textContent =
            user.stats?.profileViews || 0;
          const joinDate = new Date(user.stats?.joinDate);
          document.getElementById('memberSince').textContent =
            `${joinDate.getMonth() + 1}/${joinDate.getFullYear()}`;

          // Bio
          if (profile.bio) {
            document.getElementById('profileBio').textContent = profile.bio;
          } else {
            document.getElementById('bioSection').style.display = 'none';
          }

          // Photos
          const photos = profile.photos?.filter(p => !p.isProfile) || [];
          const galleryContainer = document.getElementById('galleryPhotos');
          if (photos.length > 0) {
            galleryContainer.innerHTML = photos
              .map(
                photo =>
                  `<img src="${photo.path}" alt="Photo" class="gallery-photo" style="width: 100px; height: 100px; object-fit: cover; margin: 5px; border-radius: 8px;" />`
              )
              .join('');
          } else {
            galleryContainer.innerHTML = '<p>Aucune photo de galerie</p>';
          }
        }

        initEventListeners() {
          document
            .getElementById('sendMessageBtn')
            .addEventListener('click', () => {
              alert(
                'Redirection vers la page de messages pour envoyer un message √† cet utilisateur'
              );
              window.location.href = '/messages';
            });

          document
            .getElementById('backToDirectoryBtn')
            .addEventListener('click', () => {
              window.location.href = '/directory';
            });

          const backBtn = document.getElementById('backBtn');
          if (backBtn) {
            backBtn.addEventListener('click', () => {
              window.location.href = '/directory';
            });
          }
        }

        showError(message) {
          document.getElementById('loadingIndicator').style.display = 'none';
          document.getElementById('profileContent').style.display = 'none';
          document.getElementById('errorMessage').style.display = 'block';
          document
            .getElementById('errorMessage')
            .querySelector('p').textContent = message;
        }

        hideLoading() {
          document.getElementById('loadingIndicator').style.display = 'none';
          document.getElementById('profileContent').style.display = 'block';
        }
      }

      // CSS simple
      const style = document.createElement('style');
      style.textContent = `
        .profile-header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 2rem;
          border-radius: 12px;
          margin-bottom: 2rem;
        }
        .profile-info {
          display: flex;
          align-items: center;
          gap: 2rem;
        }
        .profile-photo {
          width: 120px;
          height: 120px;
          border-radius: 50%;
          object-fit: cover;
          border: 4px solid white;
        }
        .profile-actions {
          display: flex;
          gap: 1rem;
          margin-bottom: 2rem;
        }
        .profile-section {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          margin-bottom: 2rem;
        }
        .photo-gallery {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
        }
        .loading-container {
          text-align: center;
          padding: 4rem;
        }
        .error-message {
          text-align: center;
          padding: 4rem;
          background: #f8d7da;
          color: #721c24;
          border-radius: 8px;
        }
        @media (max-width: 768px) {
          .profile-info {
            flex-direction: column;
            text-align: center;
          }
          .profile-actions {
            flex-direction: column;
          }
        }
      `;
      document.head.appendChild(style);

      // Initialiser
      document.addEventListener('DOMContentLoaded', () => {
        new SimpleProfileView();
      });
    </script>
  </body>
</html>
