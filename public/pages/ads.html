<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Annonces √ârotiques - HotMeet</title>
    <link rel="stylesheet" href="/css/style.css?v=6" />
    <link rel="stylesheet" href="/css/pages.css?v=1" />
    <link rel="stylesheet" href="/css/animations.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <nav class="nav">
        <a href="/" class="nav-brand">
          <img
            src="/images/logo-hotmeet.png"
            alt="HotMeet - Rencontres Adultes Premium"
            class="logo-img"
          />
          <span class="logo-text">HotMeet</span>
        </a>

        <div class="nav-menu" id="navMenu">
          <a href="/" class="nav-link">Accueil</a>
          <a href="/directory" class="nav-link">Annuaire</a>
          <a href="/ads" class="nav-link active">Annonces</a>
          <a href="/tonight" class="nav-link">Ce Soir</a>
          <a href="/cam" class="nav-link">Cam-to-Cam</a>
          <a href="/messages" class="nav-link"
            >Messages
            <span
              class="notification-badge"
              id="messageBadge"
              style="display: none"
              >0</span
            ></a
          >
          <a href="/profile" class="nav-link">Mon Profil</a>
        </div>

        <div class="nav-actions">
          <button class="btn-secondary" id="loginBtn">Connexion</button>
          <button class="btn-primary" id="registerBtn">Inscription</button>
          <div class="mobile-menu-toggle" id="mobileMenuToggle">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="pages-container ads-container">
      <div class="container">
        <div class="page-header">
          <h1>Annonces √ârotiques</h1>
          <p>
            Exprimez vos fantasmes et trouvez des partenaires pour des plans
            sp√©cifiques - Publication et r√©ponse r√©serv√©es aux membres premium
          </p>
        </div>

        <!-- Section d'explication de la fonctionnalit√© -->
        <div class="card">
          <h2>Fonctionnalit√© Premium</h2>
          <div class="grid grid-3">
            <div class="feature-item">
              <div class="feature-icon">üí¨</div>
              <h3>Expression Libre</h3>
              <p>D√©crivez vos envies et fantasmes en toute discr√©tion</p>
            </div>
            <div class="feature-item">
              <div class="feature-icon">üîç</div>
              <h3>Recherche Cibl√©e</h3>
              <p>Trouvez des personnes partageant vos int√©r√™ts sp√©cifiques</p>
            </div>
            <div class="feature-item">
              <div class="feature-icon">üîí</div>
              <h3>S√©curit√©</h3>
              <p>Annonces v√©rifi√©es et mod√©r√©es pour votre s√©curit√©</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Cr√©er une annonce</h2>
          <form class="ads-form">
            <div class="form-group">
              <label for="adTitle">Titre de l'annonce</label>
              <input
                type="text"
                id="adTitle"
                class="form-input"
                placeholder="Titre accrocheur pour votre annonce"
              />
            </div>

            <div class="form-group">
              <label for="adDescription">Description</label>
              <textarea
                id="adDescription"
                class="form-input"
                placeholder="D√©crivez vos envies et attentes..."
                rows="4"
              ></textarea>
            </div>

            <div class="form-group">
              <label for="adInterests">Pratiques recherch√©es</label>
              <input
                type="text"
                id="adInterests"
                class="form-input"
                placeholder="S√©par√©es par des virgules"
              />
            </div>

            <!-- Section Photos Visibles -->
            <div class="form-group">
              <label>Photos Visibles</label>
              <p class="form-help">Photos accessibles √† tous les membres</p>
              <div class="upload-zone">
                <p>
                  Glissez-d√©posez vos photos ici ou cliquez pour s√©lectionner
                </p>
                <input
                  type="file"
                  multiple
                  accept="image/*"
                  id="visiblePhotos"
                  class="file-input"
                />
                <button type="button" class="btn-secondary upload-btn">
                  S√©lectionner des photos
                </button>
                <div id="visiblePhotosPreview" class="photos-preview"></div>
              </div>
            </div>

            <!-- Section Photos sur Demande -->
            <div class="form-group">
              <label>Photos sur Demande</label>
              <p class="form-help">
                Photos uniquement visibles apr√®s acceptation de votre part
              </p>
              <div class="upload-zone">
                <p>Glissez-d√©posez vos photos priv√©es ici</p>
                <input
                  type="file"
                  multiple
                  accept="image/*"
                  id="privatePhotos"
                  class="file-input"
                />
                <button type="button" class="btn-secondary upload-btn">
                  S√©lectionner des photos priv√©es
                </button>
                <div id="privatePhotosPreview" class="photos-preview"></div>
              </div>
            </div>

            <button type="submit" class="btn-primary">Publier l'annonce</button>
          </form>
        </div>

        <div class="card">
          <h2>Annonces r√©centes</h2>
          <div class="empty-state">
            <p>Fonctionnalit√© en cours de d√©veloppement</p>
            <p>Les annonces √©rotiques seront bient√¥t disponibles</p>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h4>HotMeet</h4>
            <p>
              La plateforme premium de rencontres adultes pour des exp√©riences
              authentiques et s√©curis√©es.
            </p>
          </div>
          <div class="footer-section">
            <h4>Navigation</h4>
            <ul class="footer-links">
              <li><a href="/">Accueil</a></li>
              <li><a href="/directory">Annuaire</a></li>
              <li><a href="/ads">Annonces</a></li>
              <li><a href="/tonight">Ce Soir</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>L√©gal</h4>
            <ul class="footer-links">
              <li><a href="/legal">Mentions l√©gales</a></li>
              <li><a href="/legal#privacy">Politique de confidentialit√©</a></li>
              <li><a href="/legal#terms">Conditions d'utilisation</a></li>
              <li><a href="/legal#cookies">Cookies</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Contact</h4>
            <ul class="footer-links">
              <li><a href="mailto:support@hotmeet.ch">Support</a></li>
              <li><a href="/help">Aide</a></li>
              <li><a href="/about">√Ä propos</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>
            &copy; 2024 HotMeet. Tous droits r√©serv√©s. R√©serv√© aux adultes de 18
            ans et plus.
          </p>
        </div>
      </div>
    </footer>

    <script>
      // Gestion de l'upload de photos
      document.querySelectorAll('.upload-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const inputId = this.previousElementSibling.id;
          document.getElementById(inputId).click();
        });
      });

      // Gestion de l'affichage des photos
      document
        .getElementById('visiblePhotos')
        .addEventListener('change', handlePhotoUpload);
      document
        .getElementById('privatePhotos')
        .addEventListener('change', handlePhotoUpload);

      let visiblePhotoFiles = [];
      let privatePhotoFiles = [];

      function handlePhotoUpload(e) {
        const files = e.target.files;
        const previewId = e.target.id + 'Preview';
        const previewContainer = document.getElementById(previewId);

        previewContainer.innerHTML = '';

        // Stocker les fichiers selon le type
        if (e.target.id === 'visiblePhotos') {
          visiblePhotoFiles = Array.from(files);
        } else if (e.target.id === 'privatePhotos') {
          privatePhotoFiles = Array.from(files);
        }

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const reader = new FileReader();

          reader.onload = function (e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('preview-thumbnail');
            previewContainer.appendChild(img);
          };

          reader.readAsDataURL(file);
        }
      }

      // Gestion du formulaire
      document
        .querySelector('.ads-form')
        .addEventListener('submit', async function (e) {
          e.preventDefault();

          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;

          try {
            // Afficher √©tat de chargement
            submitBtn.textContent = 'Publication...';
            submitBtn.disabled = true;

            // R√©cup√©rer les donn√©es du formulaire
            const title = document.getElementById('adTitle').value.trim();
            const description = document
              .getElementById('adDescription')
              .value.trim();
            const interests = document
              .getElementById('adInterests')
              .value.trim();

            // Validation
            if (!title || !description) {
              throw new Error('Le titre et la description sont obligatoires');
            }

            // Cr√©er FormData pour l'envoi
            const formData = new FormData();
            formData.append('type', 'fantasme'); // Type par d√©faut
            formData.append('title', title);
            formData.append('description', description);
            formData.append('location', 'France'); // Valeur par d√©faut
            formData.append(
              'date',
              new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
            ); // Demain par d√©faut

            // Ajouter les pratiques
            if (interests) {
              const practicesArray = interests
                .split(',')
                .map(p => p.trim())
                .filter(p => p);
              formData.append('pratiques', JSON.stringify(practicesArray));
            }

            // Ajouter les photos visibles
            visiblePhotoFiles.forEach(file => {
              formData.append('photos', file);
            });

            // Ajouter les photos priv√©es (√† impl√©menter plus tard)
            privatePhotoFiles.forEach(file => {
              formData.append('privatePhotos', file);
            });

            // Envoyer la requ√™te
            const response = await fetch('/api/ads', {
              method: 'POST',
              body: formData,
              headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
              },
            });

            const result = await response.json();

            if (result.success) {
              // Succ√®s
              showNotification('Annonce publi√©e avec succ√®s !', 'success');

              // R√©initialiser le formulaire
              e.target.reset();
              document.getElementById('visiblePhotosPreview').innerHTML = '';
              document.getElementById('privatePhotosPreview').innerHTML = '';
              visiblePhotoFiles = [];
              privatePhotoFiles = [];

              // Recharger les annonces
              loadAds();
            } else {
              throw new Error(
                result.message || 'Erreur lors de la publication'
              );
            }
          } catch (error) {
            console.error('Erreur publication annonce:', error);
            showNotification(error.message, 'error');
          } finally {
            // Restaurer le bouton
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

      // Fonction pour afficher les notifications
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          z-index: 10000;
          font-weight: 500;
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 5000);
      }

      // Charger les annonces existantes
      async function loadAds() {
        try {
          const response = await fetch('/api/ads?limit=10');
          const result = await response.json();

          if (result.success && result.ads.length > 0) {
            displayAds(result.ads);
          }
        } catch (error) {
          console.error('Erreur chargement annonces:', error);
        }
      }

      // Afficher les annonces
      function displayAds(ads) {
        const adsContainer = document.querySelector('.empty-state');
        adsContainer.innerHTML = '';

        ads.forEach(ad => {
          const adElement = document.createElement('div');
          adElement.className = 'ad-card';
          adElement.innerHTML = `
            <div class="ad-header">
              <h3>${ad.title}</h3>
              <span class="ad-date">${new Date(ad.createdAt).toLocaleDateString('fr-FR')}</span>
            </div>
            <p class="ad-description">${ad.description}</p>
            ${
              ad.criteria.pratiques.length > 0
                ? `
              <div class="ad-tags">
                ${ad.criteria.pratiques.map(p => `<span class="tag">${p}</span>`).join('')}
              </div>
            `
                : ''
            }
            <div class="ad-footer">
              <span class="ad-location">üìç ${ad.location}</span>
              <button class="btn-primary btn-sm" onclick="viewAd('${ad._id}')">Voir</button>
            </div>
          `;
          adsContainer.appendChild(adElement);
        });
      }

      // Fonction pour voir une annonce
      function viewAd(adId) {
        // Rediriger vers la page de d√©tail (√† cr√©er plus tard)
        window.location.href = `/ads/${adId}`;
      }

      // Charger les annonces au chargement de la page
      document.addEventListener('DOMContentLoaded', function () {
        loadAds();
      });

      // Menu mobile
      document
        .getElementById('mobileMenuToggle')
        .addEventListener('click', function () {
          const navMenu = document.getElementById('navMenu');
          navMenu.classList.toggle('active');
          this.classList.toggle('active');
        });
    </script>

    <!-- Script de notifications globales -->
    <script src="/js/global-notifications.js"></script>
  </body>
</html>
