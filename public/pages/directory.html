<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Annuaire - HotMeet</title>
    <link rel="stylesheet" href="/css/style.css?v=6" />
    <link rel="stylesheet" href="/css/pages.css?v=1" />
    <link rel="stylesheet" href="/css/animations.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <nav class="nav">
        <a href="/" class="nav-brand">
          <img
            src="/images/logo-hotmeet.png"
            alt="HotMeet - Rencontres Adultes Premium"
            class="logo-img"
          />
          <span class="logo-text">HotMeet</span>
        </a>

        <div class="nav-menu" id="navMenu">
          <a href="/" class="nav-link">Accueil</a>
          <a href="/directory" class="nav-link active">Annuaire</a>
          <a href="/ads" class="nav-link">Annonces</a>
          <a href="/tonight" class="nav-link">Ce Soir</a>
          <a href="/cam" class="nav-link">Cam-to-Cam</a>
          <a href="/messages" class="nav-link">Messages</a>
          <a href="/profile" class="nav-link">Mon Profil</a>
        </div>

        <div class="nav-actions">
          <button class="btn-secondary" id="loginBtn">Connexion</button>
          <button class="btn-primary" id="registerBtn">Inscription</button>
          <div class="mobile-menu-toggle" id="mobileMenuToggle">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="pages-container">
      <div class="container">
        <!-- Hero Section -->
        <section class="hero" style="min-height: 40vh; padding-top: 100px">
          <div class="hero-content">
            <div class="hero-text">
              <h1 class="hero-title">Annuaire des membres</h1>
              <h2 class="hero-subtitle">
                Découvrez les profils de notre communauté
              </h2>
              <p class="hero-description">
                Parcourez les profils authentiques de nos membres et trouvez des
                personnes partageant vos intérêts
              </p>
            </div>
          </div>
        </section>

        <!-- Filtres de recherche -->
        <section class="filters-section">
          <div class="filters-card">
            <h3>Filtrer les résultats</h3>
            <form id="filtersForm" class="filters-form">
              <div class="filter-group">
                <label for="ageMin">Âge minimum</label>
                <input
                  type="number"
                  id="ageMin"
                  name="ageMin"
                  min="18"
                  max="100"
                  placeholder="18"
                />
              </div>
              <div class="filter-group">
                <label for="ageMax">Âge maximum</label>
                <input
                  type="number"
                  id="ageMax"
                  name="ageMax"
                  min="18"
                  max="100"
                  placeholder="100"
                />
              </div>
              <div class="filter-group">
                <label for="sexe">Genre</label>
                <select id="sexe" name="sexe">
                  <option value="">Tous</option>
                  <option value="homme">Homme</option>
                  <option value="femme">Femme</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="filtrePays">Pays</label>
                <select id="filtrePays" name="filtrePays">
                  <option value="">Tous les pays</option>
                  <option value="france">France</option>
                  <option value="suisse">Suisse</option>
                  <option value="belgique">Belgique</option>
                  <option value="allemagne">Allemagne</option>
                  <option value="italie">Italie</option>
                  <option value="espagne">Espagne</option>
                  <option value="portugal">Portugal</option>
                  <option value="pays-bas">Pays-Bas</option>
                  <option value="luxembourg">Luxembourg</option>
                  <option value="autriche">Autriche</option>
                  <option value="royaume-uni">Royaume-Uni</option>
                  <option value="irlande">Irlande</option>
                  <option value="danemark">Danemark</option>
                  <option value="suede">Suède</option>
                  <option value="norvege">Norvège</option>
                  <option value="finlande">Finlande</option>
                  <option value="pologne">Pologne</option>
                  <option value="republique-tcheque">République Tchèque</option>
                  <option value="slovaquie">Slovaquie</option>
                  <option value="hongrie">Hongrie</option>
                  <option value="roumanie">Roumanie</option>
                  <option value="bulgarie">Bulgarie</option>
                  <option value="grece">Grèce</option>
                  <option value="croatie">Croatie</option>
                  <option value="slovenie">Slovénie</option>
                  <option value="estonie">Estonie</option>
                  <option value="lettonie">Lettonie</option>
                  <option value="lituanie">Lituanie</option>
                  <option value="malte">Malte</option>
                  <option value="chypre">Chypre</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="filtreRegion">Région</label>
                <select id="filtreRegion" name="filtreRegion">
                  <option value="">Toutes les régions</option>
                  <!-- Les régions seront chargées dynamiquement selon le pays -->
                </select>
              </div>

              <div class="filter-group">
                <label for="filtreVille">Ville</label>
                <input
                  type="text"
                  id="filtreVille"
                  name="filtreVille"
                  placeholder="Nom de la ville"
                />
              </div>
              <div class="filter-actions">
                <button type="submit" class="btn-primary">
                  Appliquer les filtres
                </button>
                <button type="button" id="resetFilters" class="btn-secondary">
                  Réinitialiser
                </button>
              </div>
            </form>
          </div>
        </section>

        <!-- Résultats -->
        <section class="results-section">
          <div class="results-header">
            <h3 id="resultsCount">Chargement des profils...</h3>
            <div class="sort-options">
              <label for="sortBy">Trier par:</label>
              <select id="sortBy">
                <option value="lastActive">Dernière activité</option>
                <option value="age">Âge</option>
                <option value="name">Nom</option>
              </select>
            </div>
          </div>

          <div class="profiles-grid" id="profilesGrid">
            <!-- Les profils seront chargés ici dynamiquement -->
          </div>

          <div class="pagination" id="pagination">
            <!-- La pagination sera générée ici -->
          </div>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h4>HotMeet</h4>
            <p>
              La plateforme premium de rencontres adultes pour des expériences
              authentiques et sécurisées.
            </p>
          </div>
          <div class="footer-section">
            <h4>Navigation</h4>
            <ul class="footer-links">
              <li><a href="/">Accueil</a></li>
              <li><a href="/directory">Annuaire</a></li>
              <li><a href="/ads">Annonces</a></li>
              <li><a href="/tonight">Ce Soir</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Légal</h4>
            <ul class="footer-links">
              <li><a href="/legal">Mentions légales</a></li>
              <li><a href="/legal#privacy">Politique de confidentialité</a></li>
              <li><a href="/legal#terms">Conditions d'utilisation</a></li>
              <li><a href="/legal#cookies">Cookies</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Contact</h4>
            <ul class="footer-links">
              <li><a href="mailto:support@hotmeet.ch">Support</a></li>
              <li><a href="/help">Aide</a></li>
              <li><a href="/about">À propos</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>
            &copy; 2024 HotMeet. Tous droits réservés. Réservé aux adultes de 18
            ans et plus.
          </p>
          <p><strong>Vérification d'âge requise</strong></p>
        </div>
      </div>
    </footer>

    <!-- JavaScript principal -->
    <script src="/js/app.js"></script>

    <!-- JavaScript pour l'annuaire -->
    <script>
      class DirectoryPage {
        constructor() {
          this.currentPage = 1;
          this.limit = 12;
          this.filters = {};
          this.sortBy = 'lastActive';
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.loadUsers();
        }

        setupEventListeners() {
          // Formulaire de filtres
          document
            .getElementById('filtersForm')
            .addEventListener('submit', e => {
              e.preventDefault();
              this.applyFilters();
            });

          // Réinitialisation des filtres
          document
            .getElementById('resetFilters')
            .addEventListener('click', () => {
              this.resetFilters();
            });

          // Tri
          document.getElementById('sortBy').addEventListener('change', e => {
            this.sortBy = e.target.value;
            this.loadUsers();
          });
        }

        applyFilters() {
          const formData = new FormData(document.getElementById('filtersForm'));
          this.filters = {
            ageMin: formData.get('ageMin') || '',
            ageMax: formData.get('ageMax') || '',
            sexe: formData.get('sexe') || '',
            localisation: formData.get('localisation') || '',
          };
          this.currentPage = 1;
          this.loadUsers();
        }

        resetFilters() {
          document.getElementById('filtersForm').reset();
          this.filters = {};
          this.currentPage = 1;
          this.loadUsers();
        }

        async loadUsers() {
          try {
            const params = new URLSearchParams({
              page: this.currentPage,
              limit: this.limit,
              ...this.filters,
            });

            const response = await fetch(`/api/users?${params}`);
            const result = await response.json();

            if (result.success) {
              this.displayUsers(result.users);
              this.updatePagination(result.pagination);
              this.updateResultsCount(result.pagination.total);
            } else {
              this.showError('Erreur lors du chargement des profils');
            }
          } catch (error) {
            console.error('Erreur:', error);
            this.showError('Erreur de connexion');
          }
        }

        displayUsers(users) {
          const grid = document.getElementById('profilesGrid');

          if (users.length === 0) {
            grid.innerHTML = `
              <div class="no-results">
                <h4>Aucun profil trouvé</h4>
                <p>Essayez de modifier vos critères de recherche</p>
              </div>
            `;
            return;
          }

          grid.innerHTML = users
            .map(
              user => `
            <div class="profile-card">
              <div class="profile-image">
                ${this.getProfileImage(user)}
                ${user.premium.isPremium ? '<span class="premium-badge">PREMIUM</span>' : ''}
                ${user.isOnline ? '<span class="online-indicator">🟢 En ligne</span>' : ''}
              </div>
              <div class="profile-info">
                <h4>${user.profile.nom}</h4>
                <p class="profile-age">${user.profile.age} ans</p>
                <p class="profile-location">${user.profile.localisation}</p>
                <p class="profile-gender">${this.getGenderLabel(user.profile.sexe)}</p>
                <div class="profile-actions">
                  <button class="btn-primary" onclick="directoryPage.viewProfile('${user.id}')">
                    Voir le profil
                  </button>
                </div>
              </div>
            </div>
          `
            )
            .join('');
        }

        getProfileImage(user) {
          // Vérifier si l'utilisateur a des photos
          if (user.profile.photos && user.profile.photos.length > 0) {
            // Trouver la photo de profil principale ou prendre la première
            const profilePhoto =
              user.profile.photos.find(photo => photo.isProfile) ||
              user.profile.photos[0];

            // Si la photo est floutée, afficher une version floutée
            if (profilePhoto.isBlurred) {
              return `
                <div class="blurred-photo-container">
                  <img src="${profilePhoto.path}" alt="${user.profile.nom}" class="blurred-photo">
                  <div class="unblur-overlay">
                    <button class="unblur-btn" onclick="directoryPage.requestUnblur('${user.id}', '${profilePhoto._id}')">
                      👁️ Dévoiler la photo
                    </button>
                  </div>
                </div>
              `;
            } else {
              return `<img src="${profilePhoto.path}" alt="${user.profile.nom}">`;
            }
          } else {
            // Photo par défaut si aucune photo n'est disponible
            return `<img src="/images/default-avatar.jpg" alt="${user.profile.nom}">`;
          }
        }

        getGenderLabel(gender) {
          const labels = {
            homme: 'Homme',
            femme: 'Femme',
            autre: 'Autre',
          };
          return labels[gender] || gender;
        }

        // Fonction pour demander le dévoilement d'une photo
        async requestUnblur(userId, photoId) {
          try {
            const token = localStorage.getItem('hotmeet_token');
            const response = await fetch(
              `/api/uploads/photo/${photoId}/unblur-request`,
              {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  ...(token && { Authorization: `Bearer ${token}` }),
                },
                body: JSON.stringify({ targetUserId: userId }),
              }
            );

            const result = await response.json();

            if (result.success) {
              this.showSuccess('Demande de dévoilement envoyée');
              // Recharger les utilisateurs pour mettre à jour l'affichage
              this.loadUsers();
            } else {
              this.showError(
                result.error.message || 'Erreur lors de la demande'
              );
            }
          } catch (error) {
            console.error('Erreur demande dévoilement:', error);
            this.showError('Erreur lors de la demande de dévoilement');
          }
        }

        updatePagination(pagination) {
          const paginationDiv = document.getElementById('pagination');
          const { page, pages, total } = pagination;

          if (pages <= 1) {
            paginationDiv.innerHTML = '';
            return;
          }

          let html = '<div class="pagination-controls">';

          // Bouton précédent
          if (page > 1) {
            html += `<button class="pagination-btn" onclick="directoryPage.goToPage(${page - 1})">← Précédent</button>`;
          }

          // Pages
          for (
            let i = Math.max(1, page - 2);
            i <= Math.min(pages, page + 2);
            i++
          ) {
            html += `<button class="pagination-btn ${i === page ? 'active' : ''}" onclick="directoryPage.goToPage(${i})">${i}</button>`;
          }

          // Bouton suivant
          if (page < pages) {
            html += `<button class="pagination-btn" onclick="directoryPage.goToPage(${page + 1})">Suivant →</button>`;
          }

          html += '</div>';
          paginationDiv.innerHTML = html;
        }

        updateResultsCount(total) {
          document.getElementById('resultsCount').textContent =
            `${total} profil${total > 1 ? 's' : ''} trouvé${total > 1 ? 's' : ''}`;
        }

        goToPage(page) {
          this.currentPage = page;
          this.loadUsers();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        viewProfile(userId) {
          window.location.href = `/profile-view?id=${userId}`;
        }

        showError(message) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          errorDiv.textContent = message;
          errorDiv.style.cssText = `
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            text-align: center;
          `;

          const resultsSection = document.querySelector('.results-section');
          resultsSection.insertBefore(errorDiv, resultsSection.firstChild);

          setTimeout(() => errorDiv.remove(), 5000);
        }
      }

      // Initialisation
      document.addEventListener('DOMContentLoaded', () => {
        window.directoryPage = new DirectoryPage();
      });
    </script>

    <style>
      .pages-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding-top: 70px;
      }

      .filters-section {
        margin: 2rem 0;
      }

      .filters-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .filters-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
      }

      .filter-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #2c3e50;
      }

      .filter-group input,
      .filter-group select {
        padding: 0.75rem;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1rem;
      }

      .filter-actions {
        display: flex;
        gap: 1rem;
        align-items: end;
      }

      .results-section {
        margin: 2rem 0;
      }

      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        color: white;
      }

      .sort-options {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .sort-options select {
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #ddd;
      }

      .profiles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .profile-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }

      .profile-card:hover {
        transform: translateY(-5px);
      }

      .profile-image {
        position: relative;
        height: 200px;
        overflow: hidden;
      }

      .profile-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .premium-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ffd700;
        color: #000;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .online-indicator {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #4caf50;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .profile-info {
        padding: 1.5rem;
      }

      .profile-info h4 {
        margin: 0 0 0.5rem 0;
        color: #2c3e50;
        font-size: 1.2rem;
      }

      .profile-age,
      .profile-location,
      .profile-gender {
        margin: 0.25rem 0;
        color: #7f8c8d;
      }

      .profile-actions {
        margin-top: 1rem;
      }

      .no-results {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem;
        color: white;
      }

      .no-results h4 {
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }

      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
      }

      .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .pagination-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .pagination-btn:hover {
        background: #f8f9fa;
      }

      .pagination-btn.active {
        background: #8a2be2;
        color: white;
        border-color: #8a2be2;
      }

      /* Styles pour les photos floutées et le système de dévoilement */
      .blurred-photo-container {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      .blurred-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: blur(20px);
        transition: filter 0.3s ease;
      }

      .unblur-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .blurred-photo-container:hover .unblur-overlay {
        opacity: 1;
      }

      .unblur-btn {
        background: #8a2be2;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s ease;
      }

      .unblur-btn:hover {
        background: #7b1fa2;
      }

      .unblurred-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      @media (max-width: 768px) {
        .filters-form {
          grid-template-columns: 1fr;
        }

        .filter-actions {
          flex-direction: column;
        }

        .profiles-grid {
          grid-template-columns: 1fr;
        }

        .results-header {
          flex-direction: column;
          gap: 1rem;
          align-items: flex-start;
        }

        .pagination-controls {
          flex-wrap: wrap;
          justify-content: center;
        }

        .unblur-overlay {
          opacity: 1; /* Toujours visible sur mobile */
        }
      }
    </style>
  </body>
</html>
